<!-- TP Start API Node HTML -->
<script type="text/javascript">
    // Isolate this code
    (function () {
        'use strict'

        const nodeLabel = 'tp-start-api'

        RED.nodes.registerType(nodeLabel, {
            category: 'Task Package',
            color: '#FFCDD2',
            defaults: {
                name: { value: '' },
                tp_id: { value: '', required: true },
                auth_token: { value: '' }
            },
            inputs: 1,
            outputs: 1,
            inputLabels: ['Start TP request'],
            outputLabels: ['API response'],
            icon: 'tp.svg',
            align: 'right',
            paletteLabel: 'API - START',
            label: function () { 
                return this.name || 'API - START'
            },
            oneditprepare: function() {
                // Populate tp_id dropdown with available task packages
                const populateTaskPackages = () => {
                    const dropdown = $('#node-input-tp_id')
                    const currentValue = this.tp_id
                    dropdown.empty()
                    dropdown.append('<option value="">Select task package...</option>')
                    
                    // Scan existing on-start and tp-start nodes in workspace for task packages
                    RED.nodes.eachNode((node) => {
                        if ((node.type === 'on-start' || node.type === 'tp-start') && node.tp_id) {
                            const selected = node.tp_id === currentValue ? 'selected' : ''
                            const displayName = node.tp_name || node.tp_id
                            dropdown.append(`<option value="${node.tp_id}" ${selected}>${node.tp_id} - ${displayName}</option>`)
                        }
                    })
                    
                    // If no existing value and no tp-start nodes found, allow manual entry
                    if (currentValue && dropdown.find('option[value="' + currentValue + '"]').length === 0) {
                        dropdown.append(`<option value="${currentValue}" selected>${currentValue}</option>`)
                    }
                }
                
                // Populate on dialog open
                populateTaskPackages.call(this)
                
                // Refresh button functionality
                $('#refresh-tp-list').on('click', () => {
                    populateTaskPackages.call(this)
                })
                
                // Allow manual entry if needed
                $('#node-input-tp_id').on('change', function() {
                    // This allows for manual entry while still providing dropdown convenience
                })
            }
        })

    })()
</script>

<script type="text/html" data-template-name="tp-start-api">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="API - START">
    </div>
    
    <div class="form-row">
        <label for="node-input-tp_id"><i class="fa fa-tasks"></i> Task Package ID</label>
        <select id="node-input-tp_id" style="width: 70%;">
            <option value="">Select task package...</option>
        </select>
        <button type="button" id="refresh-tp-list" class="red-ui-button" style="margin-left: 10px;">
            <i class="fa fa-refresh"></i> Refresh
        </button>
    </div>
    
    <div class="form-row">
        <label for="node-input-auth_token"><i class="fa fa-key"></i> Auth Token</label>
        <input type="password" id="node-input-auth_token" placeholder="Bearer token">
        <div class="form-tips">
            <b>Optional:</b> Authentication token. Can be overridden by <code>msg.accessToken</code>.
        </div>
    </div>
    
    <div class="form-tips">
        <p><b>Input Message:</b></p>
        <ul>
            <li><code>msg.tp_id</code> - Override the configured task package ID</li>
            <li><code>msg.payload</code> - Data to include with the TP call request</li>
            <li><code>msg.accessToken</code> - Override the authentication token</li>
        </ul>
        <p><b>Note:</b> This node calls TPs via API and outputs the API response.</p>
    </div>
</script>

<script type="text/html" data-help-name="tp-start-api">
    <p>Starts task packages via API. This is a control node for programmatically invoking TPs from within Node-RED flows.</p>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>tp_id <span class="property-type">string</span></dt>
        <dd><b>Optional:</b> Override the configured task package ID for this call request.</dd>
        
        <dt>payload <span class="property-type">any</span></dt>
        <dd>Data to include with the TP call request. This will be passed to the task package flow.</dd>
        
        <dt>accessToken <span class="property-type">string</span></dt>
        <dd><b>Optional:</b> Override the configured authentication token for this request.</dd>
    </dl>
    
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>API response from the task package call request. Contains <code>tpc_id</code> and <code>status</code> on success, or <code>error</code> on failure.</dd>
        
        <dt>topic <span class="property-type">string</span></dt>
        <dd>Set to "tp-start-success" on successful call or "tp-start-error" on failure.</dd>
        
        <dt>tp_data <span class="property-type">object</span></dt>
        <dd>Additional task package data including tpc_id, tp_id, status, and created_at timestamp (success only).</dd>
        
        <dt>error <span class="property-type">boolean</span></dt>
        <dd>Set to true when an error occurs (error messages only).</dd>
    </dl>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">string</span></dt>
        <dd>Optional name for this node instance.</dd>
        
        <dt>Task Package ID <span class="property-type">string</span></dt>
        <dd>
            <b>Required:</b> The tp_id of the task package type to start. Can be overridden by <code>msg.tp_id</code>.
            Select from available task packages or enter manually.
        </dd>
        
        <dt>Auth Token <span class="property-type">string</span></dt>
        <dd>
            <b>Optional:</b> Bearer authentication token for API calls.
            Can be overridden by <code>msg.accessToken</code>. Leave empty if authentication is not required.
        </dd>
    </dl>
    
    <h3>API Integration</h3>
    <p>This node makes HTTP POST calls to <code>/task-package/start</code> with the following structure:</p>
    <pre><code>{
  "tp_id": "tp01",
  ...payload fields
}</code></pre>
    
    <h3>Status Indicators</h3>
    <ul>
        <li><b>Blue ring:</b> Ready to start TPs</li>
        <li><b>Yellow dot:</b> API call in progress</li>
        <li><b>Green dot:</b> TP started successfully (shows tpc_id)</li>
        <li><b>Red ring:</b> Start failed (check Node-RED logs)</li>
    </ul>
    
    <h3>Usage Examples</h3>
    
    <h4>Basic Start</h4>
    <p>Configure the node with a tp_id and send any message to trigger the start:</p>
    <pre><code>msg.payload = {
    "room": "101",
    "priority": "high"
}</code></pre>
    
    <h4>Dynamic TP Type with Token</h4>
    <p>Override the TP type and authentication at runtime:</p>
    <pre><code>msg.tp_id = "emergency_transport"
msg.accessToken = "eyJhbGciOiJIUzI1NiIs..."
msg.payload = {
    "patient_id": "12345",
    "destination": "OR2"
}</code></pre>
    
    <h3>Error Handling</h3>
    <p>Errors are logged to Node-RED and shown in the node status. Common errors include:</p>
    <ul>
        <li>Missing tp_id</li>
        <li>API endpoint unreachable</li>
        <li>Authentication failures</li>
        <li>Invalid payload data</li>
    </ul>
</script>