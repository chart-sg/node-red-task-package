<!-- Task Package End Node HTML -->
<script type="text/javascript">
    // Isolate this code
    (function () {
        'use strict'

        const nodeLabel = 'tp-end'

        RED.nodes.registerType(nodeLabel, {
            category: 'Task Package',
            color: '#FFAAAA',
            defaults: {
                name: { value: '' },
                config_node: { value: '', type: 'tp-config' }
            },
            inputs: 1,
            outputs: 0,
            inputLabels: ['Task completion'],
            icon: 'font-awesome/fa-flag-checkered',
            paletteLabel: nodeLabel,
            label: function () { 
                return this.name || 'tp-end'
            }
        })

    })()
</script>

<script type="text/html" data-template-name="tp-end">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Task Package End">
    </div>
    
    <div class="form-tips">
        <p><b>Note:</b> This node should be placed at the end of your task package flow. 
        It will automatically determine if the task completed normally or was cancelled.</p>
    </div>
</script>

<script type="text/html" data-help-name="tp-end">
    <p>Terminates task package execution and updates the final status in the database.</p>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>tp_data <span class="property-type">object</span></dt>
        <dd><b>Required:</b> Task package data from tp-start or other tp-* nodes containing task information.</dd>
        
        <dt>payload <span class="property-type">any</span></dt>
        <dd>Any payload data from the flow - preserved for logging purposes.</dd>
    </dl>
    
    <h3>Outputs</h3>
    <p>None. This node terminates the task package flow.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">string</span></dt>
        <dd>Optional name for this node instance.</dd>
        
    </dl>
    
    <h3>Behavior</h3>
    <p>When this node receives a message:</p>
    <ol>
        <li>Checks flow context for cancellation status</li>
        <li>Determines final status: 'completed' (normal) or 'cancelled'</li>
        <li>Updates database with final status and timestamp</li>
        <li>Clears flow context variables</li>
        <li>Updates node status indicator</li>
    </ol>
    
    <h3>Status Determination</h3>
    <ul>
        <li><b>Completed:</b> Task finished normally through the flow</li>
        <li><b>Cancelled:</b> tp-cancel was triggered before reaching tp-end</li>
    </ul>
    
    <h3>Flow Context Cleanup</h3>
    <p>This node clears the following flow context variables:</p>
    <ul>
        <li><code>current_tpc_id</code></li>
        <li><code>current_tp_id</code></li>
        <li><code>current_tp_name</code></li>
        <li><code>task_cancelled</code></li>
    </ul>
    
    <h3>Usage</h3>
    <p>
        Place this node at the end of your task package flow, after all business logic is complete.
        Connect it to the final node in your process to ensure proper task completion tracking.
    </p>
    
    <h3>Example Flow</h3>
    <pre>
[tp-start] → [business-logic] → [more-logic] → [tp-end]
                                                   ↑
                                         (receives msg.tp_data)
    </pre>
    
    <h3>Database Integration</h3>
    <p>
        This node updates the task_packages_created table with:
    </p>
    <ul>
        <li>Final status (completed/cancelled)</li>
        <li>Completion timestamp</li>
        <li>Updated timestamp</li>
    </ul>
    
    <h3>Error Handling</h3>
    <p>
        If the input message doesn't contain tp_data, the node will log an error. 
        Ensure your flow properly passes tp_data through all intermediate nodes.
    </p>
</script>
